## mako
<%! from django.utils.translation import ugettext as _ %>
<%page args="active_page=None" />

<%
if active_page is None and active_page_context is not UNDEFINED:
  # If active_page is not passed in as an argument, it may be in the context as active_page_context
  active_page = active_page_context

def url_class(is_active):
  if is_active:
    return "active"
  return ""
%>
<%! from courseware.tabs import get_course_tab_list %>
<%! from courseware.views import notification_image_for_tab %>
<%! from django.core.urlresolvers import reverse %>
<%! from openedx.core.djangoapps.course_groups.partition_scheme import get_cohorted_user_partition %>
<%! from staticfiles.storage import staticfiles_storage %>
<%! from student.models import CourseEnrollment, CourseAccessRole %>
<%
  cohorted_user_partition = get_cohorted_user_partition(course.id)
  show_preview_menu = staff_access and active_page in ['courseware', 'info']
  is_student_masquerade = masquerade and masquerade.role == 'student'
  masquerade_group_id = masquerade.group_id if masquerade else None
  invite_students_url = "{}#view-membership".format(reverse('instructor_dashboard', args=[course.id.to_deprecated_string()]))
  user_is_enrolled = user.is_authenticated() and CourseEnrollment.is_enrolled(user, course.id)
%>

% if show_preview_menu and False:
    <nav class="wrapper-preview-menu">
        <div class="preview-menu">
            <ol class="preview-actions">
                <li class="action-preview">
                    <form action="#" class="action-preview-form" method="post">
                        <label for="action-preview-select" class="action-preview-label">${_("View this course as:")}</label>
                        <select class="action-preview-select" id="action-preview-select" name="select">
                            <option value="staff" ${"selected" if not is_student_masquerade else ""}>${_("Staff")}</option>
                            <option value="student" ${"selected" if is_student_masquerade and not masquerade_group_id else ""}>${_("Student")}</option>
                            % if cohorted_user_partition:
                                % for group in sorted(cohorted_user_partition.groups, key=lambda group: group.name):
                                <option value="group.id" data-group-id="${group.id}" ${"selected" if masquerade_group_id == group.id else ""}>
                                    ${_("Student in {content_group}").format(content_group=group.name)}
                                </option>
                                % endfor
                            % endif
                        </select>
                        <button type="submit" class="sr" name="submit" value="submit">${_("set preview mode")}</button>
                    </form>
                </li>
            </ol>
        </div>
    </nav>
% endif

% if disable_tabs is UNDEFINED or not disable_tabs:
<nav class="${active_page} wrapper-course-material">
  <div class="course-material">
    <ol class="course-tabs">
      % for tab in get_course_tab_list(course, user):
        <%
            tab_is_active = (tab.tab_id == active_page) or (tab.tab_id == default_tab)
            tab_image = notification_image_for_tab(tab, user, course)
        %>
          <li>
             <a href="${tab.link_func(course, reverse) | h}" class="${url_class(tab_is_active)}">
                 ${_(tab.name) | h}
                 % if tab_is_active:
                   <span class="sr">, current location</span>
                 %endif
                 % if tab_image:
                   ## Translators: 'needs attention' is an alternative string for the
                   ## notification image that indicates the tab "needs attention".
                   <img src="${tab_image}" alt="${_('needs attention')}" />
                 %endif
             </a>
          </li>
      % endfor
      <%block name="extratabs" />
      <%
      roles = []
      if user.is_authenticated():
        roles = CourseAccessRole.objects.filter(user=user, course_id=course.id).values_list('role', flat=True)
      %>
      % if 'staff' in roles:
        <li style="float:right"><a href="${invite_students_url}" id="invitestudents" style="color:green">${_("Manage Students")}</a></li>
      % elif course.labster_demo:
        <li style="float:right"><a href="#invite-students-modal" rel="leanModal" class="invite-students" style="color:green" data-course-name="${course.display_name_with_default}" data-course-location="${course.location.org}/${course.location.course}/${course.location.run}">${_("Invite Students to Try Course")}</a></li>
      % endif
    </ol>
  </div>
</nav>
%endif

% if show_preview_menu:
<script type="text/javascript">
(function() {
    var element = $('.action-preview-select');
    % if disable_student_access:
        element.attr("disabled", true);
        element.attr("title", "${_("Course is not yet visible to students.")}");
    % endif

    element.change(function() {
        var selectedOption, data;
        if (element.attr("disabled")) {
           return alert("${_("You cannot view the course as a student or beta tester before the course release date.")}");
        }
        selectedOption = element.find('option:selected');
        data = {
            role: selectedOption.val() === 'staff' ? 'staff' : 'student',
            user_partition_id: ${cohorted_user_partition.id if cohorted_user_partition else 'null'},
            group_id: selectedOption.data('group-id')
        };
        $.ajax({
            url: '/courses/${course.id}/masquerade',
            type: 'POST',
            dataType: 'json',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(result) {
                location.reload();
            },
            error: function() {
                alert('Error: cannot connect to server');
            }
        });
    });
}());
</script>
% endif

<script>
  window.cms_base = "${settings.CMS_BASE}";
  % if request.user.is_authenticated():
  window.user_token_key = "${request.user.labster_user.token_key}";
  % endif
</script>
<script type="text/javascript" src="${staticfiles_storage.url('js/invite_students.js')}"></script>
% if request.user.is_authenticated():
<script>
$(function() {
  var progressUrl = '${reverse('student_progress_detail', args=[course.id, user.id])}',
    progressLi = $('ol.course-tabs li:nth-child(5)');

  progressLi.find('a').prop('href', progressUrl);
});
</script>
% endif

<section id="invite-students-modal" class="modal invite-students-modal" aria-hidden="true">
  <div class="inner-wrapper" role="alertdialog" aria-labelledy="invite-students-modal-title">
    <button class="close-modal">
      <i class="icon-remove"></i>
      <span class="sr">
        ${_('Close')}
      </span>
    </button>

    <header>
      <h2 id="invite-students-modal-title">
        ${_("Invite Students to Try")} <span id="invite-students-course-name"></span>
        <span class="sr">,
          ${_("window open")}
        </span>
      </h2>
      <h2 id="invite-students-run-title" style="display:none">
        Preparing the Course
      </h2>
      <h2 id="invite-students-complete-title" style="display:none">
        Invitations sent successfully!
      </h2>
      <hr/>
    </header>
    <div id="invite-students-error" class="modal-form-error"></div>
    <div id="invite-students-content">
      <form id="invite-students-run" style="display:none" action="">
        <p>Please wait while we are preparing the course for you</p>
        <p><progress style="width:100%"></progress></p>
      </form>
      <form id="invite-students-form" method="post" data-remote="true" action="">
        <input id="invite-students-course-location" type="hidden" value="" name="course_location">
        <p>You can invite up to 3 students or colleagues to try the Labster labs
        for free, and help evaluate the fit with your science courses.</p>
        <p>This is a great way to quickly hear from your own students,
        how they like Labster.</p>
        <p>
          <div><input type="email" name="student_emails" placeholder="1st student email" required></div>
          <div><input type="email" name="student_emails" placeholder="2nd student email"></div>
          <div><input type="email" name="student_emails" placeholder="3rd student email"></div>
        </p>
        <div class="submit">
          <input name="submit" type="submit" value="${_('Send invitation to students')}" />
        </div>
      </form>
      <form id="invite-students-complete" style="display:none" action="#" method="get">
        <p>Your students have now received an invitation to try Labster for free, and we have created a private course for you and your students, so you can easily follow their progress from our teacher dashboard.</p>
        <p>Once you and your students have evaluated it, you can buy more licenses for all your students
        easily using the "Buy student licenses" button and a credit card.</p>
        <p>We will also contact you one of the coming days, to hear more about how your evaluation of Labster is going. </p>
        <p>If you have any questions, please feel free to call us or email us at any time.</p>
        <p>We are here ready to help you get going with Labster.<br>
        <p>You can see our contact info on our
        <a href="http://labster.com/support" target="_blank">support page</a>.</p>
        <div class="submit">
          <input name="submit" type="submit" value="${_('Enter Your New Course')}" />
        </div>
      </form>
    </div>
  </div>
</section>

